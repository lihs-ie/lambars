# Issue 001: axum ハンドラの async/clippy 問題
# Phase 13 実装時に発生した技術的負債

issue:
  id: ISSUE-001
  title: axum ハンドラが async 必須だが await を使用していない
  severity: low  # 動作に影響なし、コード品質の問題
  created_at: "2026-01-01"
  status: open

problem:
  summary: |
    axum のハンドラは async fn である必要があるが、
    現在の実装では await を使用していないため clippy 警告が発生する。

  current_code: |
    // src/api/axum_handler.rs
    #[allow(clippy::unused_async)]  // ← この抑制が必要
    pub async fn place_order_handler(body: String) -> impl IntoResponse {
        let request = HttpRequest::new(body);
        let io_response = place_order_api(&request);
        let response = io_response.run_unsafe();  // ← 同期的な呼び出し
        // ...
    }

  root_cause: |
    1. axum はハンドラに async fn を要求する（tokio ランタイム上で動作）
    2. 現在の IO モナドの run_unsafe() は同期的（blocking）な操作
    3. async fn 内で await を使わないと clippy::unused_async 警告が発生
    4. #[allow] で警告を抑制しているが、根本解決ではない

  technical_debt:
    - clippy 警告の抑制はコード品質の低下を示唆
    - blocking 操作が tokio ランタイムのスレッドをブロックする可能性
    - 将来的に実際の I/O（DB、外部 API）を追加した場合に問題が顕在化

analysis:
  options:
    - id: option_1
      name: tokio::task::spawn_blocking を使用
      description: |
        blocking 操作を tokio の blocking スレッドプールで実行する。
        axum の推奨パターン。
      pros:
        - clippy 警告が解消される（await を使用するため）
        - tokio ランタイムをブロックしない
        - 既存の IO モナドパターンを維持できる
        - 将来的な拡張性が高い
      cons:
        - スレッド間のオーバーヘッドが発生（微小）
        - エラーハンドリングが若干複雑になる（JoinError の処理）
      complexity: low
      recommended: true

    - id: option_2
      name: IO モナドを async 対応にする
      description: |
        IO モナド自体を Future ベースに再設計する。
        run_async() メソッドを追加し、内部で async 操作を実行可能にする。
      pros:
        - 真の async 対応になる
        - 将来的に async I/O を直接扱える
      cons:
        - lambars ライブラリ本体の大幅な変更が必要
        - 既存のテストへの影響が大きい
        - Phase 13 のスコープを大きく超える
      complexity: high
      recommended: false

    - id: option_3
      name: 現状維持（#[allow] で抑制）
      description: |
        現在の実装を維持し、clippy 警告を抑制し続ける。
      pros:
        - 追加の変更が不要
        - 動作には問題なし
      cons:
        - 技術的負債が残る
        - tokio ランタイムをブロックする可能性
        - コードレビューで指摘される可能性
      complexity: none
      recommended: false

recommendation:
  selected_option: option_1
  rationale: |
    tokio::task::spawn_blocking は axum の公式ドキュメントでも推奨されている
    パターンであり、最小限の変更で clippy 警告を解消できる。

    spawn_blocking は:
    - blocking 操作を専用のスレッドプールで実行
    - tokio の async ランタイムをブロックしない
    - .await で結果を待つため clippy 警告が解消

implementation_plan:
  files_to_modify:
    - path: src/api/axum_handler.rs
      changes:
        - "#[allow(clippy::unused_async)] を削除"
        - "tokio::task::spawn_blocking でラップ"
        - "JoinError のエラーハンドリングを追加"

  before_code: |
    #[allow(clippy::unused_async)]
    pub async fn place_order_handler(body: String) -> impl IntoResponse {
        let request = HttpRequest::new(body);
        let io_response = place_order_api(&request);
        let response = io_response.run_unsafe();

        (
            StatusCode::from_u16(response.status_code()).unwrap_or(StatusCode::INTERNAL_SERVER_ERROR),
            [(axum::http::header::CONTENT_TYPE, "application/json")],
            response.body().to_string(),
        )
    }

  after_code: |
    pub async fn place_order_handler(body: String) -> impl IntoResponse {
        // blocking 操作を spawn_blocking で実行
        let result = tokio::task::spawn_blocking(move || {
            let request = HttpRequest::new(body);
            let io_response = place_order_api(&request);
            io_response.run_unsafe()
        })
        .await;

        match result {
            Ok(response) => (
                StatusCode::from_u16(response.status_code()).unwrap_or(StatusCode::INTERNAL_SERVER_ERROR),
                [(axum::http::header::CONTENT_TYPE, "application/json")],
                response.body().to_string(),
            )
                .into_response(),
            Err(_) => (
                StatusCode::INTERNAL_SERVER_ERROR,
                [(axum::http::header::CONTENT_TYPE, "application/json")],
                r#"{"type":"InternalError","message":"Task execution failed"}"#.to_string(),
            )
                .into_response(),
        }
    }

  validation:
    - cargo fmt -- --check
    - cargo clippy -- -D warnings  # unused_async 警告が出ないことを確認
    - cargo test --package order-taking-sample

references:
  - name: tokio::task::spawn_blocking
    url: https://docs.rs/tokio/latest/tokio/task/fn.spawn_blocking.html
  - name: axum - Handling blocking operations
    url: https://docs.rs/axum/latest/axum/#handlers
  - name: clippy::unused_async
    url: https://rust-lang.github.io/rust-clippy/master/index.html#unused_async
