# Docker Compose configuration for CI environments
#
# Optimized for:
#   - Fast startup (reduced healthcheck intervals)
#   - Minimal logging (RUST_LOG=warn)
#   - GitHub Actions cache integration
#
# Usage:
#   docker compose -f compose.ci.yaml up -d --build --wait
#   # Run tests/benchmarks
#   docker compose -f compose.ci.yaml down -v

services:
  postgres:
    image: postgres:16-alpine
    container_name: benchmark-ci-postgres
    environment:
      POSTGRES_USER: benchmark
      POSTGRES_PASSWORD: benchmark
      POSTGRES_DB: benchmark
    volumes:
      - ./postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U benchmark -d benchmark"]
      interval: 2s
      timeout: 2s
      retries: 15
      start_period: 5s
    tmpfs:
      - /var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    container_name: benchmark-ci-redis
    command: redis-server --appendonly no --save ""
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 2s
      timeout: 2s
      retries: 15
    tmpfs:
      - /data

  api:
    build:
      context: ../../..
      dockerfile: benches/api/docker/Dockerfile
    container_name: benchmark-ci-api
    environment:
      HOST: "0.0.0.0"
      PORT: "3000"
      # Storage/Cache mode (can be overridden by scenario)
      STORAGE_MODE: "${STORAGE_MODE:-postgres}"
      CACHE_MODE: "${CACHE_MODE:-redis}"
      DATABASE_URL: postgres://benchmark:benchmark@postgres:5432/benchmark
      REDIS_URL: redis://redis:6379
      RUST_LOG: "${RUST_LOG:-info,task_management_benchmark_api=debug,tower_http=debug}"
      RUST_BACKTRACE: "1"
      # Concurrency settings from scenario (ENV-REQ-011)
      # 未設定時は空文字列となり、API 側で各ライブラリのデフォルト値を使用
      WORKER_THREADS: "${WORKER_THREADS:-}"
      DATABASE_POOL_SIZE: "${DATABASE_POOL_SIZE:-}"
      REDIS_POOL_SIZE: "${REDIS_POOL_SIZE:-}"
      # Cache settings from scenario
      CACHE_STRATEGY: "${CACHE_STRATEGY:-read-through}"
      CACHE_TTL_SECS: "${CACHE_TTL_SECS:-60}"
      CACHE_ENABLED: "${CACHE_ENABLED:-true}"
      # Debug endpoints (disabled by default)
      ENABLE_DEBUG_ENDPOINTS: "${ENABLE_DEBUG_ENDPOINTS:-false}"
      # Bulk optimization
      USE_BULK_OPTIMIZATION: "${USE_BULK_OPTIMIZATION:-true}"
      BULK_CHUNK_SIZE: "${BULK_CHUNK_SIZE:-50}"
      BULK_CONCURRENCY_LIMIT: "${BULK_CONCURRENCY_LIMIT:-4}"
    ports:
      - "3002:3000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 2s
      timeout: 2s
      retries: 20
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 2G

networks:
  default:
    name: benchmark-ci-network
