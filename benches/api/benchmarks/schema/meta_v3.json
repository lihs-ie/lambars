{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://github.com/lihs-ie/lambars/blob/main/benches/api/benchmarks/schema/meta_v3.json",
  "title": "Benchmark Meta v3",
  "description": "meta.json schema v3 - metrics integrity guarantee",
  "type": "object",
  "required": ["version", "scenario", "execution", "results", "errors"],
  "properties": {
    "version": {
      "type": "string",
      "const": "3.0",
      "description": "Schema version"
    },
    "scenario": {
      "type": "object",
      "required": ["name", "storage_mode", "cache_mode"],
      "properties": {
        "name": {
          "type": "string",
          "minLength": 1,
          "description": "Scenario name"
        },
        "storage_mode": {
          "type": "string",
          "enum": ["in_memory", "postgres"],
          "description": "Storage backend mode"
        },
        "cache_mode": {
          "type": "string",
          "enum": ["in_memory", "redis", "none"],
          "description": "Cache layer mode"
        },
        "data_scale": {
          "type": "string",
          "pattern": "^1e[0-9]+$",
          "description": "Data scale (e.g., 1e2, 1e4, 1e6)"
        },
        "payload_variant": {
          "type": "string",
          "enum": ["small", "medium", "large", "minimal", "standard", "complex", "heavy"],
          "description": "Payload size variant"
        },
        "rps_profile": {
          "type": "string",
          "enum": ["steady", "ramp", "burst", "constant", "ramp_up_down", "step_up"],
          "description": "RPS load profile"
        },
        "hit_rate": {
          "type": ["integer", "null"],
          "minimum": 0,
          "maximum": 100,
          "description": "Expected cache hit rate (0-100)"
        },
        "cache_strategy": {
          "type": "string",
          "enum": ["read-through", "write-through", "write-behind"],
          "description": "Cache strategy"
        },
        "fail_injection": {
          "type": ["number", "null"],
          "minimum": 0,
          "maximum": 1,
          "description": "Error injection rate (0.0-1.0)"
        },
        "retry": {
          "type": "boolean",
          "description": "Retry enabled"
        },
        "endpoint": {
          "type": "string",
          "description": "Target endpoint"
        }
      }
    },
    "execution": {
      "type": "object",
      "required": ["timestamp", "threads", "connections", "duration_seconds"],
      "properties": {
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "Execution timestamp (ISO 8601)"
        },
        "threads": {
          "type": "integer",
          "minimum": 1,
          "description": "Number of threads"
        },
        "connections": {
          "type": "integer",
          "minimum": 1,
          "description": "Number of connections"
        },
        "duration_seconds": {
          "type": "number",
          "minimum": 0,
          "description": "Benchmark duration in seconds"
        },
        "workers": {
          "type": ["integer", "null"],
          "minimum": 1,
          "description": "Number of workers"
        },
        "pool_sizes": {
          "type": ["integer", "null"],
          "minimum": 1,
          "description": "Pool sizes"
        },
        "database_pool_size": {
          "type": ["integer", "null"],
          "minimum": 1,
          "description": "Database pool size"
        },
        "redis_pool_size": {
          "type": ["integer", "null"],
          "minimum": 1,
          "description": "Redis pool size"
        },
        "seed": {
          "type": ["integer", "null"],
          "description": "Random seed for reproducibility"
        }
      }
    },
    "results": {
      "type": "object",
      "required": ["requests", "duration_seconds", "error_rate", "latency_ms", "http_status", "retries"],
      "properties": {
        "requests": {
          "type": "integer",
          "minimum": 0,
          "description": "Total number of requests"
        },
        "duration_seconds": {
          "type": "number",
          "minimum": 0,
          "description": "Actual duration in seconds"
        },
        "error_rate": {
          "type": ["number", "null"],
          "minimum": 0,
          "maximum": 1,
          "description": "Error rate as 0.x number (NOT string). null if requests=0."
        },
        "rps": {
          "type": ["number", "null"],
          "minimum": 0,
          "description": "Requests per second"
        },
        "latency_ms": {
          "type": "object",
          "required": ["p50", "p90", "p99"],
          "properties": {
            "avg": {
              "type": ["number", "null"],
              "exclusiveMinimum": 0,
              "description": "Average latency in ms. null if unavailable. 0 is NOT allowed."
            },
            "p50": {
              "type": ["number", "null"],
              "exclusiveMinimum": 0,
              "description": "50th percentile latency in ms. null if unavailable. 0 is NOT allowed."
            },
            "p75": {
              "type": ["number", "null"],
              "exclusiveMinimum": 0,
              "description": "75th percentile latency in ms. null if unavailable. 0 is NOT allowed."
            },
            "p90": {
              "type": ["number", "null"],
              "exclusiveMinimum": 0,
              "description": "90th percentile latency in ms. null if unavailable. 0 is NOT allowed."
            },
            "p95": {
              "type": ["number", "null"],
              "exclusiveMinimum": 0,
              "description": "95th percentile latency in ms. null if unavailable. 0 is NOT allowed."
            },
            "p99": {
              "type": ["number", "null"],
              "exclusiveMinimum": 0,
              "description": "99th percentile latency in ms. null if unavailable. 0 is NOT allowed."
            },
            "p999": {
              "type": ["number", "null"],
              "exclusiveMinimum": 0,
              "description": "99.9th percentile latency in ms. null if unavailable. 0 is NOT allowed."
            }
          },
          "description": "Latency percentiles in milliseconds. Use null for missing values. 0 is NOT allowed as it indicates data corruption."
        },
        "http_status": {
          "type": "object",
          "patternProperties": {
            "^[1-5][0-9]{2}$": {
              "type": "integer",
              "minimum": 0
            }
          },
          "additionalProperties": false,
          "description": "HTTP status code distribution. Keys are 3-digit status codes (e.g., '200', '409'). Empty object is allowed when requests=0."
        },
        "retries": {
          "type": "integer",
          "minimum": 0,
          "description": "Total number of retries"
        },
        "phase_metrics": {
          "type": ["object", "null"],
          "description": "Phase-aware RPS metrics aggregated from phase_result.json files (REQ-PATE-001). null for single-phase scenarios without phase files.",
          "properties": {
            "phase_count": {
              "type": "integer",
              "minimum": 1,
              "description": "Number of phases executed"
            },
            "peak_phase_rps": {
              "type": "number",
              "minimum": 0,
              "description": "Maximum actual_rps across all phases"
            },
            "min_phase_rps": {
              "type": "number",
              "minimum": 0,
              "description": "Minimum actual_rps across all phases"
            },
            "weighted_rps": {
              "type": "number",
              "minimum": 0,
              "description": "Duration-weighted average RPS across all phases"
            },
            "sustain_phase_rps": {
              "type": ["number", "null"],
              "minimum": 0,
              "description": "Profile-aware sustained RPS: main phase for steady, sustain phase for ramp_up_down, max burst phase for burst, longest-duration phase(s) average for step_up"
            }
          }
        }
      }
    },
    "errors": {
      "type": "object",
      "required": ["socket_errors", "http_4xx", "http_5xx"],
      "properties": {
        "socket_errors": {
          "type": "object",
          "required": ["connect", "read", "write", "timeout", "total"],
          "properties": {
            "connect": {
              "type": "integer",
              "minimum": 0,
              "description": "Connection errors"
            },
            "read": {
              "type": "integer",
              "minimum": 0,
              "description": "Read errors"
            },
            "write": {
              "type": "integer",
              "minimum": 0,
              "description": "Write errors"
            },
            "timeout": {
              "type": "integer",
              "minimum": 0,
              "description": "Timeout errors"
            },
            "total": {
              "type": "integer",
              "minimum": 0,
              "description": "Total socket errors"
            }
          }
        },
        "http_4xx": {
          "type": "integer",
          "minimum": 0,
          "description": "Total 4xx HTTP errors"
        },
        "http_5xx": {
          "type": "integer",
          "minimum": 0,
          "description": "Total 5xx HTTP errors"
        },
        "http_status_total": {
          "type": "integer",
          "minimum": 0,
          "description": "Total HTTP errors (4xx + 5xx)"
        }
      }
    },
    "cache": {
      "type": ["object", "null"],
      "properties": {
        "hit_rate": {
          "type": ["number", "null"],
          "minimum": 0,
          "maximum": 1,
          "description": "Cache hit rate (0.0-1.0)"
        },
        "misses": {
          "type": ["integer", "null"],
          "minimum": 0,
          "description": "Cache misses"
        },
        "hits": {
          "type": ["integer", "null"],
          "minimum": 0,
          "description": "Cache hits"
        }
      }
    },
    "profiling": {
      "type": ["object", "null"],
      "properties": {
        "perf_data": {
          "type": ["string", "null"],
          "description": "Path to perf data file"
        },
        "flamegraph": {
          "type": ["string", "null"],
          "description": "Path to flamegraph file"
        },
        "pprof": {
          "type": ["string", "null"],
          "description": "Path to pprof file"
        }
      }
    },
    "files": {
      "type": ["object", "null"],
      "properties": {
        "wrk_output": {
          "type": ["string", "null"],
          "description": "Path to wrk output file"
        },
        "lua_metrics": {
          "type": ["string", "null"],
          "description": "Path to lua_metrics.json file"
        }
      }
    },
    "environment": {
      "type": ["object", "null"],
      "properties": {
        "api_url": {
          "type": "string",
          "format": "uri",
          "description": "API URL"
        },
        "rust_version": {
          "type": "string",
          "description": "Rust version"
        },
        "os": {
          "type": "string",
          "description": "Operating system"
        },
        "cpu_cores": {
          "type": "integer",
          "minimum": 1,
          "description": "Number of CPU cores"
        },
        "memory_gb": {
          "type": "integer",
          "minimum": 0,
          "description": "Memory in GB"
        }
      }
    }
  }
}
