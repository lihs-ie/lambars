# lambars ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å•é¡Œ ç·åˆåˆ†æãƒ¬ãƒãƒ¼ãƒˆ
#
# æ¦‚è¦:
#   lambars APIå…¨ä½“ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å•é¡Œã‚’èª¿æŸ»ãƒ»ãƒ©ãƒ³ã‚­ãƒ³ã‚°åŒ–ã—ã€
#   å¯¾å¿œé‡è¦åº¦ã‚’è©•ä¾¡ã—ãŸçµæœã‚’ã¾ã¨ã‚ãŸãƒ¬ãƒãƒ¼ãƒˆ
#
# ä½œæˆæ—¥: 2026-01-17
# æ›´æ–°æ—¥: 2026-01-17

version: "1.0.0"
name: "performance_analysis_ranking"
status: "active"
created_at: "2026-01-17T17:30:00+09:00"

# åˆ†æã‚µãƒãƒªãƒ¼
summary:
  total_issues: 5
  critical: 2
  high: 1
  medium: 1
  low: 1

  key_findings:
    - "PersistentTreeMap ã¯æ¨™æº–BTreeMapã®2,100å€é…ãã€å®Ÿç”¨ä¸å¯ãƒ¬ãƒ™ãƒ«"
    - "Writer Effect ã® tell chain ã¯ O(nÂ²) ã®è¨ˆç®—é‡å•é¡Œã‚’æŠ±ãˆã‚‹"
    - "Trampoline ã¯æ·±ã„å†å¸°ã§1,935å€ã®é…å»¶ãŒç™ºç”Ÿ"
    - "Algebraic Effect ã¯3-5.5å€ã®é…å»¶ã ãŒæŠ½è±¡åŒ–ã‚³ã‚¹ãƒˆã¨ã—ã¦è¨±å®¹ç¯„å›²"
    - "eff_async! ã‚¹ã‚¿ã‚¤ãƒ«ã¯å¾“æ¥ã‚¹ã‚¿ã‚¤ãƒ«ã§ä»£æ›¿å¯èƒ½"

# ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å•é¡Œãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆé…å»¶å€ç‡é †ï¼‰
ranking:
  - rank: 1
    api: "PersistentTreeMap"
    module: "persistent::treemap"
    file: "src/persistent/treemap.rs"

    performance:
      delay_ratio: "2,100x"
      baseline: "BTreeMap 465Î¼s (10,000 insert)"
      current: "1.02ç§’ (10,000 insert)"
      trend: "ã‚µã‚¤ã‚ºå¢—åŠ ã«å¯¾ã—ã¦æŒ‡æ•°çš„ã«åŠ£åŒ–"

    severity: "critical"
    severity_label: "ğŸ”´ Critical"

    bottleneck:
      primary: "éåº¦ãªcloneæ“ä½œï¼ˆ40-50%ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ï¼‰"
      details:
        - "Red-Black Treeå®Ÿè£…ã§å„rotateæ“ä½œæ™‚ã«æœ€å¤§6å›ã®cloneãŒç™ºç”Ÿ"
        - "src/persistent/treemap.rs ã«45ç®‡æ‰€ã®cloneå‘¼ã³å‡ºã—"
        - "ãƒ„ãƒªãƒ¼æ§‹é€ ã®é«˜ã•ãŒé«˜ãã‚­ãƒ£ãƒƒã‚·ãƒ¥åŠ¹ç‡ãŒä½ã„"

    impact:
      scope: "å¤§è¦æ¨¡ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆï¼ˆ10,000ä»¶ä»¥ä¸Šï¼‰ã§ã®ä½¿ç”¨"
      severity: "å®Ÿè³ªä½¿ç”¨ä¸å¯èƒ½"
      affected_users: "æ°¸ç¶šãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’ä½¿ç”¨ã™ã‚‹å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼"

    solution:
      recommended: "B-Treeå®Ÿè£…ã¸ã®ç§»è¡Œ"
      expected_improvement: "50-100å€ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„"
      complexity: "é«˜ï¼ˆå¤§è¦æ¨¡ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å¿…è¦ï¼‰"
      effort_estimate: "2-4é€±é–“"

    tracking:
      github_issue: "#163"
      internal_issue: "docs/internal/issues/20260115_1400_persistent_treemap_performance.yaml"
      status: "issueåŒ–æ¸ˆã¿ã€è¦ä»¶å®šç¾©æœªä½œæˆ"

  - rank: 2
    api: "Trampoline"
    module: "control::trampoline"
    file: "src/control/trampoline.rs"

    performance:
      delay_ratio: "1,935x"
      baseline: "ç›´æ¥å®Ÿè£… æ•°Î¼s (100,000å›å†å¸°)"
      current: "æ•°ç§’ (100,000å›å†å¸°)"
      breakdown:
        - depth: 100
          direct: "1Î¼s"
          trampoline: "13.7Î¼s"
          ratio: "13.7x"
        - depth: 1000
          trampoline: "6.2ç§’"
        - depth: 100000
          ratio: "1,935x"

    severity: "high"
    severity_label: "ğŸŸ¡ High"

    bottleneck:
      primary: "æ¯ã‚¹ãƒ†ãƒƒãƒ—ã®ãƒ’ãƒ¼ãƒ—ã‚¢ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ + å‹•çš„ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒ"
      details:
        - "ãƒ’ãƒ¼ãƒ—ã‚¢ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³: 40-50% (Box<dyn FnOnce()>)"
        - "å‹•çš„ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒ: 20-30% (vtable lookup)"
        - "ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°: 15-20% (3ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒã‚§ãƒƒã‚¯)"
        - "ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒŸã‚¹: 10-15% (ãƒ¡ãƒ¢ãƒªéå±€æ‰€æ€§)"

    impact:
      scope: "æ·±ã„å†å¸°ãŒå¿…è¦ãªã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ "
      severity: "ä½¿ç”¨åˆ¶é™ã‚ã‚Š"
      affected_users: "ã‚¹ã‚¿ãƒƒã‚¯å®‰å…¨ãªå†å¸°å‡¦ç†ã‚’å¿…è¦ã¨ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼"

    solution:
      recommended: "7æ®µéšã®æœ€é©åŒ–è¨ˆç”»"
      phases:
        - phase: 1
          name: "ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŒ–ã®å¼·åŒ–"
          expected_improvement: "5-15%"
        - phase: 2
          name: "flat_map ã® Done å³æ™‚è©•ä¾¡"
          expected_improvement: "10-20%"
        - phase: 3
          name: "FlatMap ãƒã‚§ãƒ¼ãƒ³ã®æœ€é©åŒ–"
          expected_improvement: "15-25%"
        - phase: 4
          name: "run() ãƒ«ãƒ¼ãƒ—ã®å¾®æœ€é©åŒ–"
          expected_improvement: "3-5%"
        - phase: 5
          name: "map ã® Done å³æ™‚è©•ä¾¡"
          expected_improvement: "5-10%"
        - phase: 6
          name: "ãƒãƒƒãƒå‡¦ç†ã®å°å…¥"
          expected_improvement: "10-15%"
        - phase: 7
          name: "ç¶™ç¶šã‚¹ã‚¿ãƒƒã‚¯ã®æ˜ç¤ºç®¡ç†"
          expected_improvement: "15-20%"
      total_expected_improvement: "50%ä»¥ä¸Šï¼ˆ1,935å€ â†’ 100å€ä»¥ä¸‹ç›®æ¨™ï¼‰"
      complexity: "ä¸­ï¼ˆæ®µéšçš„ã«å®Ÿæ–½å¯èƒ½ï¼‰"
      effort_estimate: "1-2é€±é–“"

    tracking:
      github_issue: "#164"
      internal_issue: "docs/internal/issues/20260115_1405_trampoline_performance.yaml"
      requirements: "docs/internal/requirements/20260115_1700_trampoline_performance.yaml"
      status: "è¦ä»¶å®šç¾©å®Œæˆã€å®Ÿè£…æœªé–‹å§‹"

  - rank: 3
    api: "Writer Effect (tell chain)"
    module: "effect::writer"
    file: "src/effect/writer.rs"

    performance:
      delay_ratio: "740x (depth 10â†’100)"
      baseline: "ç·šå½¢ãªã‚‰ 89Î¼s (depth 100)"
      current: "6.6ms (depth 100)"
      breakdown:
        - depth: 10
          time: "8.9Î¼s"
        - depth: 100
          time: "6.6ms"
          note: "ç·šå½¢ãªã‚‰10å€ã®ã¯ãšãŒ740å€å¢—åŠ "
      complexity: "O(nÂ²)"

    severity: "critical"
    severity_label: "ğŸ”´ Critical"

    bottleneck:
      primary: "æ¯å›å…¨ä½“ã‚’cloneã™ã‚‹è¨­è¨ˆ"
      details:
        - "nå›ã®tellã§åˆè¨ˆ 0 + 1 + 2 + ... + (n-1) = O(nÂ²) ã®clone"
        - "log.borrow().clone() ãŒæ¯å›å®Ÿè¡Œã•ã‚Œã‚‹"
        - "Stringçµåˆã®éåŠ¹ç‡ãªcombine()å‘¼ã³å‡ºã—"
      code_example: |
        // ç¾åœ¨ã®å®Ÿè£…ã®O(nÂ²)å•é¡Œ:
        // 1å›ç›®: clone 0 items, combine 1 item
        // 2å›ç›®: clone 1 item, combine 1 item
        // ...
        // nå›ç›®: clone (n-1) items, combine 1 item

    impact:
      scope: "ãƒ­ã‚°å‡ºåŠ›ãŒå¤šã„å‡¦ç†"
      severity: "æ·±åˆ»ãªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åŠ£åŒ–"
      affected_users: "Writer ãƒ¢ãƒŠãƒ‰ã§ãƒ­ã‚°è“„ç©ã‚’è¡Œã†ãƒ¦ãƒ¼ã‚¶ãƒ¼"
      example: "100å›ã® tell ã§ 6.6ms ã¯å®Ÿç”¨ä¸Šå•é¡Œ"

    solution:
      recommended: "Vec<W> è“„ç©ãƒ‘ã‚¿ãƒ¼ãƒ³"
      expected_improvement: "10-20å€ï¼ˆ6.6ms â†’ æ•°ç™¾Î¼sï¼‰"
      complexity_change: "O(nÂ²) â†’ O(n)"
      implementation_complexity: "ä½ï¼ˆæ¯”è¼ƒçš„ã‚·ãƒ³ãƒ—ãƒ«ãªä¿®æ­£ï¼‰"
      effort_estimate: "2-3æ—¥"
      alternatives:
        - name: "Rope ãƒ‡ãƒ¼ã‚¿æ§‹é€ "
          description: "Stringçµåˆã«ç‰¹åŒ–"
        - name: "é…å»¶è©•ä¾¡ã®å°å…¥"
          description: "å®Ÿè£…ãŒè¤‡é›‘"

    tracking:
      github_issue: "#166"
      internal_issue: "docs/internal/issues/20260115_1415_writer_effect_on2.yaml"
      status: "issueåŒ–æ¸ˆã¿ã€è¦ä»¶å®šç¾©æœªä½œæˆ"

  - rank: 4
    api: "Algebraic Effect (Eff)"
    module: "effect::algebraic"
    files:
      - "src/effect/algebraic/eff.rs"
      - "src/effect/algebraic/writer.rs"

    performance:
      delay_ratio: "3-5.5x"
      breakdown:
        - effect: "Reader"
          traditional: "63ns"
          eff: "350ns"
          ratio: "5.5x"
        - effect: "State"
          traditional: "102ns"
          eff: "458ns"
          ratio: "4.5x"
        - effect: "Writer"
          traditional: "168ns"
          eff: "488ns"
          ratio: "2.9x"
      deep_chain:
        operation: "state_effect_modify[100]"
        time: "13ms"
        note: "æŒ‡æ•°çš„å¢—åŠ "

    severity: "medium"
    severity_label: "ğŸŸ¢ Medium"

    bottleneck:
      primary: "å‹æ¶ˆå»ç¶™ç¶šã«ã‚ˆã‚‹ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰"
      details:
        - "å„ flat_map ã§ 3ã¤ã® Box ãŒç”Ÿæˆã•ã‚Œã‚‹"
        - "å‹•çš„ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒã®ç´¯ç©åŠ¹æœ"
        - "æ·±ã„ã‚¨ãƒ•ã‚§ã‚¯ãƒˆãƒã‚§ãƒ¼ãƒ³ã§æŒ‡æ•°çš„ã«æ€§èƒ½åŠ£åŒ–"

    impact:
      scope: "Algebraic Effect ã‚’ä½¿ç”¨ã™ã‚‹å‡¦ç†"
      severity: "æŠ½è±¡åŒ–ã‚³ã‚¹ãƒˆã¨ã—ã¦ä¸€å®šç¨‹åº¦è¨±å®¹å¯èƒ½"
      affected_users: "é«˜åº¦ãªé–¢æ•°å‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼"

    solution:
      recommended: "ç¶™ç¶šæ§‹é€ ã®ç°¡ç´ åŒ–"
      expected_improvement: "30-50%"
      complexity: "é«˜"
      effort_estimate: "1-2é€±é–“"
      alternatives:
        - name: "ãƒ›ãƒƒãƒˆãƒ‘ã‚¹æœ€é©åŒ–"
          expected_improvement: "10-20%"
          risk: "ä½"
        - name: "ç‰¹åŒ–å‹ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®æä¾›"
          description: "ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé¸æŠå¯èƒ½"

    tracking:
      github_issue: "#165"
      internal_issue: "docs/internal/issues/20260115_1410_effect_system_performance.yaml"
      status: "issueåŒ–æ¸ˆã¿ã€è¦ä»¶å®šç¾©æœªä½œæˆ"

  - rank: 5
    api: "eff_async! ã‚¹ã‚¿ã‚¤ãƒ«"
    module: "Bank Sample Application"
    files:
      - "samples/bank/src/api/handlers/transaction.rs"
      - "samples/bank/src/api/handlers/workflow_eff.rs"

    performance:
      delay_ratio: "3.4x"
      breakdown:
        - endpoint: "Deposit (traditional)"
          throughput: "~5,000 req/s"
          latency: "20.11ms"
        - endpoint: "Deposit (eff_async!)"
          throughput: "~1,500 req/s"
          latency: "87.28ms"
        - endpoint: "Withdraw (traditional)"
          throughput: "~1,100 req/s"
          latency: "89.05ms"
        - endpoint: "Withdraw (eff_async!)"
          throughput: "~850 req/s"
          latency: "144.71ms"

    severity: "low"
    severity_label: "ğŸŸ¢ Low"

    bottleneck:
      primary: "ExceptT ãƒ¢ãƒŠãƒ‰ãƒˆãƒ©ãƒ³ã‚¹ãƒ•ã‚©ãƒ¼ãƒãƒ¼ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰"
      details:
        - "ãƒ¢ãƒŠãƒ‰ã‚¹ã‚¿ãƒƒã‚¯ã®å„å±¤ã§ã®é–¢æ•°å‘¼ã³å‡ºã—ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰"
        - "Boxing ã«ã‚ˆã‚‹è¿½åŠ ã®ãƒ’ãƒ¼ãƒ—ã‚¢ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³"

    impact:
      scope: "Bank Sample ã® eff_async! ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ"
      severity: "ä½ï¼ˆå¾“æ¥ã‚¹ã‚¿ã‚¤ãƒ«ã§ä»£æ›¿å¯èƒ½ï¼‰"
      affected_users: "eff_async! ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é¸æŠã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼"

    solution:
      recommended: "ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ä½¿ã„åˆ†ã‘ã‚’æ¨å¥¨"
      status: "æ—¢ã«ä¸¡ã‚¹ã‚¿ã‚¤ãƒ«æä¾›æ¸ˆã¿"
      guidance: |
        - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹é‡è¦–: å¾“æ¥ã® ? æ¼”ç®—å­ã‚¹ã‚¿ã‚¤ãƒ«
        - å¯èª­æ€§ãƒ»åˆæˆæ€§é‡è¦–: eff_async! ã‚¹ã‚¿ã‚¤ãƒ«
      effort_estimate: "ãªã—ï¼ˆå¯¾å¿œå®Œäº†ï¼‰"

    tracking:
      internal_issue: "docs/internal/done/issues/20260117_1700_eff_async_limited_value.yaml"
      status: "è§£æ±ºæ¸ˆã¿ï¼ˆä¸¡ã‚¹ã‚¿ã‚¤ãƒ«æä¾›ï¼‰"

# å¯¾å¿œå„ªå…ˆåº¦ãƒãƒˆãƒªãƒƒã‚¯ã‚¹
priority_matrix:
  description: |
    å½±éŸ¿åº¦ã¨å·¥æ•°ã‚’è»¸ã«ã—ãŸå„ªå…ˆåº¦ãƒãƒˆãƒªãƒƒã‚¯ã‚¹

                        å½±éŸ¿åº¦
                   ä½         é«˜
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          ä½ â”‚ Low     â”‚ Medium  â”‚
    å·¥æ•°     â”‚eff_asyncâ”‚ Eff     â”‚
             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
          é«˜ â”‚ Medium  â”‚ Criticalâ”‚
             â”‚Trampolineâ”‚TreeMap  â”‚
             â”‚         â”‚ Writer  â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  quadrants:
    - position: "é«˜å½±éŸ¿ãƒ»ä½å·¥æ•°"
      priority: "æœ€å„ªå…ˆ"
      items:
        - "Writer Effect O(nÂ²)"
    - position: "é«˜å½±éŸ¿ãƒ»é«˜å·¥æ•°"
      priority: "è¨ˆç”»çš„å¯¾å¿œ"
      items:
        - "PersistentTreeMap"
    - position: "ä½å½±éŸ¿ãƒ»é«˜å·¥æ•°"
      priority: "æ®µéšçš„å¯¾å¿œ"
      items:
        - "Trampoline"
    - position: "ä½å½±éŸ¿ãƒ»ä½å·¥æ•°"
      priority: "ç¾çŠ¶ç¶­æŒå¯"
      items:
        - "eff_async!"
        - "Algebraic Effect"

# æ¨å¥¨å¯¾å¿œé †åº
recommended_action_order:
  - order: 1
    api: "Writer Effect O(nÂ²)"
    reason: "å·¥æ•°ä½ãƒ»å½±éŸ¿é«˜ â†’ å³æ™‚å¯¾å¿œå¯èƒ½ã§åŠ¹æœå¤§"
    action: "Vec<W> è“„ç©ãƒ‘ã‚¿ãƒ¼ãƒ³ã¸ã®ä¿®æ­£"

  - order: 2
    api: "PersistentTreeMap"
    reason: "å·¥æ•°é«˜ãƒ»å½±éŸ¿é«˜ â†’ è¨ˆç”»çš„ã«ç€æ‰‹"
    action: "B-Treeå®Ÿè£…ã¸ã®ç§»è¡Œãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé–‹å§‹"

  - order: 3
    api: "Trampoline"
    reason: "æ®µéšçš„æœ€é©åŒ–ã§ç€æ‰‹å¯èƒ½"
    action: "Phase 1-3 ã‚’å„ªå…ˆå®Ÿæ–½"

  - order: 4
    api: "Algebraic Effect"
    reason: "é•·æœŸæ”¹å–„èª²é¡Œã¨ã—ã¦æ¤œè¨"
    action: "ç¶™ç¶šæ§‹é€ ã®ç°¡ç´ åŒ–ã‚’è¨­è¨ˆ"

# ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ç’°å¢ƒ
benchmark_environment:
  hardware:
    cpu: "Apple M3 Pro"
    memory: "åˆ¶é™ãªã—ï¼ˆlambarsæœ¬ä½“ï¼‰/ 1GBï¼ˆBank Sample Dockerï¼‰"
  software:
    rust_version: "1.92.0"
    docker: "Docker Desktop 4.37"
  tools:
    - "criterion 0.8"
    - "wrk 4.2.0"

# é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
related_documents:
  issues:
    - "docs/internal/issues/20260115_1400_persistent_treemap_performance.yaml"
    - "docs/internal/issues/20260115_1405_trampoline_performance.yaml"
    - "docs/internal/issues/20260115_1410_effect_system_performance.yaml"
    - "docs/internal/issues/20260115_1415_writer_effect_on2.yaml"
  requirements:
    - "docs/internal/requirements/20260115_1700_trampoline_performance.yaml"
  benchmarks:
    - "benches/"
    - "samples/bank/benchmarks/"
